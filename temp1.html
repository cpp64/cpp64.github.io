<!DOCTYPE html>
<html lang="ru">
        <head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="stylesheet" type="text/css" href="/style.css" />
                <link rel="icon" type="image/png" sizes="192x192" href="/icons/dove32w2.ico" />
                <title>temp1</title>
        </head>
        <body>
                <div id="navigation"></div>
                <script type="text/javascript" src="/jquery-3.7.1.min.js"></script>
                <script>
                        $(function () {
                                $("#navigation").load("/navigation.html");
                        });
                </script>
                <div class="main">
                        <form id="myform">
                                <p>
                                        <input id="myfile" name="files[]" multiple="" type="file" />
                                        <textarea id="text" rows="20" cols="40">click [Choose Files] to load a file</textarea>
                                </p>
                        </form>
                        <script>
                                document.forms["myform"].elements["myfile"].onchange = function (evt) {
                                        if (!window.FileReader) return; // Browser is not compatible
                                        //debugger;
                                        var reader = new FileReader();
                                        reader.onload = function (evt) {
                                                if (evt.target.readyState != 2) return;
                                                if (evt.target.error) {
                                                        alert("Error while reading file");
                                                        return;
                                                }
                                                filecontent = evt.target.result;
                                                document.forms["myform"].elements["text"].value = evt.target.result;
                                                let s = document.forms["myform"].elements["text"].value;
                                                let t = "";
                                                let table = [], row = [];
                                                for (let i = 0; i < s.length; ++i) {
                                                        if (s[i] == ";" || s[i] == "\n") {
                                                                row.push(t);
                                                                t = "";
                                                                if (row.length == 4) {
                                                                        table.push(row);
                                                                        row = [];
                                                                }
                                                        } else {
                                                                t = t + s[i];
                                                        }
                                                }
                                                let a = [];
                                                let Ncorp = 3, Ndays = 6, Nlessons = 6;
                                                for (let i = 0; i < Ncorp; ++i) {
                                                        let week = [];
                                                        for (let j = 0; j < Ndays; ++j) {
                                                                let day = [];
                                                                for (let k = 0; k < Nlessons; ++k) {
                                                                        day.push("");
                                                                }
                                                                week.push(day);
                                                        }
                                                        a.push(week);
                                                }
                                                for (let i = 1; i < table.length; ++i) {
                                                        let fio = table[i][0];
                                                        let hrs = Number(table[i][1]);
                                                        let corp = Number(table[i][2]);
                                                        //let cab = Number(table[i][3]);
                                                        for (let day = 0; day < Ndays && hrs > 0; ++day) {
                                                                for (let lesson = 0; lesson < Nlessons && hrs > 0; ++lesson) {
                                                                        if (a[corp - 1][day][lesson] == "") {
                                                                                --hrs;
                                                                                a[corp - 1][day][lesson] = fio;
                                                                        }
                                                                }
                                                        }
                                                }
                                                s = "";
                                                for (let corp = 0; corp < Ncorp; ++corp) {
                                                        s += "corpus " + (corp+1).toString() + '\n';
                                                        s += ';';
                                                        for (let day = 0; day < Ndays; ++day) {
                                                                s += "day " + (day+1).toString() + ';';
                                                        }
                                                        s += '\n';
                                                        for (let lesson = 0; lesson < Nlessons; ++lesson) {
                                                                s += "lesson " + (lesson+1).toString() + ';';
                                                                for (let day = 0; day < Ndays; ++day) {
                                                                        s += a[corp][day][lesson] + ";;";
                                                                }
                                                                s += '\n';
                                                        }
                                                }
                                                var saveData = (function () {
                                                        var a = document.createElement("a");
                                                        // document.body.appendChild(a);
                                                        // a.style = "display: none";
                                                        return function (data, fileName) {
                                                                var json = s;//JSON.stringify(data);
                                                                var blob = new Blob([json], { type: "octet/stream" });
                                                                var url = window.URL.createObjectURL(blob);
                                                                a.href = url;
                                                                a.download = fileName;
                                                                a.click();
                                                                window.URL.revokeObjectURL(url);
                                                        };
                                                })();
                                                //var data = { x: 42, s: "hello, world", d: new Date() };
                                                var fileName = "schedule.csv";
                                                //saveData(data, fileName);
                                                saveData(s, fileName);
                                        };
                                        reader.readAsText(evt.target.files[0]);
                                };
                        </script>
                </div>
        </body>
</html>
