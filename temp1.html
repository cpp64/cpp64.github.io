<!DOCTYPE html>
<html lang="ru">
        <head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="stylesheet" type="text/css" href="/style.css" />
                <link rel="icon" type="image/png" sizes="192x192" href="/icons/dove32w2.ico" />
                <title>temp1</title>
        </head>
        <body>
                <div id="navigation"></div>
                <script type="text/javascript" src="/jquery-3.7.1.min.js"></script>
                <script>
                        $(function () {
                                $("#navigation").load("/navigation.html");
                        });
                </script>
                <div class="main">
                        <input type="file" id="input">
                        <script>
                                /*let em = [];
                                if(em.length == 0)
                                        alert('empty');
                                else
                                        alert('error');*/
                                function ASCIIarrToInt(arr) {
                                        let res = 0;
                                        for (let i = 0; i < arr.length; ++i) {
                                                res = res * 10 + arr[i] - 48;
                                        }
                                        return res;
                                }
                                document.getElementById("input").addEventListener("change", handleFiles, false);
                                function handleFiles() {
                                        var fr = new FileReader();
                                        fr.onload = function () {
                                                var data = fr.result;
                                                var array = new Int8Array(data);
                                                process(array);
                                        };
                                        fr.readAsArrayBuffer(document.getElementById("input").files[0]);
                                }
                                function process(s) {
                                        //alert("data");
                                        //alert(s);
                                        let t = [];
                                        let table = [];
                                        let row = [];
                                        for (let i = 0; i < s.length; ++i) {
                                                if (s[i] == 59 || s[i] == 10) { // ';' or '\n'
                                                        row.push(t);
                                                        t = [];
                                                        if (row.length == 4) {
                                                                //alert("row");
                                                                //for (let j = 0; j < 4; ++j)
                                                                //        alert(row[j]);
                                                                table.push(row);
                                                                row = [];
                                                        }
                                                } else {
                                                        t.push(s[i]);
                                                }
                                        }
                                        let a = [];
                                        let Ncorp = 3, Ndays = 6, Nlessons = 6;
                                        for (let i = 0; i < Ncorp; ++i) {
                                                let week = [];
                                                for (let j = 0; j < Ndays; ++j) {
                                                        let day = [];
                                                        for (let k = 0; k < Nlessons; ++k) {
                                                                day.push([]);
                                                        }
                                                        week.push(day);
                                                }
                                                a.push(week);
                                        }
                                        for (let i = 1; i < table.length; ++i) {
                                                let fio = table[i][0];
                                                let hrs = ASCIIarrToInt(table[i][1]);
                                                let corp = ASCIIarrToInt(table[i][2]);
                                                //let cab = Number(table[i][3]);
                                                for (let day = 0; day < Ndays && hrs > 0; ++day) {
                                                        for (let lesson = 0; lesson < Nlessons && hrs > 0; ++lesson) {
                                                                if (a[corp - 1][day][lesson].length == 0) {
                                                                        --hrs;
                                                                        a[corp - 1][day][lesson] = fio;
                                                                }
                                                        }
                                                }
                                        }
                                        s = [];
                                        let weekday = [['M','o','n','d','a','y'], 
                                                       ['T','u','e','s','d','a','y'], 
                                                       ['W','e','d','n','e','s','d','a','y'], 
                                                       ['T','h','u','r','s','d','a','y'], 
                                                       ['F','r','i','d','a','y'], 
                                                       ['S','a','t','u','r','d','a','y'], 
                                                       ['S','u','n','d','a','y']];
                                        for (let corp = 0; corp < Ncorp; ++corp) {
                                                s.concat(['c','o','r','p','u','s',';']);
                                                for (let day = 0; day < Ndays; ++day) {
                                                        s.concat(weekday[day]);
                                                        s.push(';');
                                                }
                                                s.push('\n');
                                                for (let lesson = 0; lesson < Nlessons; ++lesson) {
                                                        //s += (lesson+1).toString() + ';';
                                                        s.push(';');
                                                        for (let day = 0; day < Ndays; ++day) {
                                                                s.concat(a[corp][day][lesson]);
                                                                s.push(';');
                                                        }
                                                        s.push('\n');
                                                }
                                                s.push('\n');
                                        }
                                        var saveData = (function () {
                                                var a = document.createElement("a");
                                                // document.body.appendChild(a);
                                                // a.style = "display: none";
                                                return function (data, fileName) {
                                                        var json = s;
                                                        var blob = new Blob([json], { type: "octet/stream" });
                                                        var url = window.URL.createObjectURL(blob);
                                                        a.href = url;
                                                        a.download = fileName;
                                                        a.click();
                                                        window.URL.revokeObjectURL(url);
                                                };
                                        })();
                                        var fileName = "schedule.csv";
                                        saveData(s, fileName);
                                }
                        </script>
                </div>
        </body>
</html>
