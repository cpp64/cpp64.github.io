<!DOCTYPE html>
<html lang="ru">
        <head>
                <meta charset="UTF-8">
                <!-- <meta charset="windows-1251"> -->
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="stylesheet" type="text/css" href="/style.css">
                <link rel="icon" type="image/png" sizes="192x192" href="/icons/dove32w2.ico">
                <title>Расписание онлайн</title>
        </head>
        <body>
                <div id="navigation"></div>
                <script type="text/javascript" src="/jquery-3.7.1.min.js"></script>
                <script>
                        $(function () {
                                $("#navigation").load("/navigation.html");
                        });
                </script>
                <div class="main">
                        <h3>Расписание онлайн</h3>
                        <p>Перед составлением расписания скачайте шаблон и заполните таблицу по образцу.</p>
                        <p><a href = "schedule.csv">Скачать шаблон</a></p>
                        <p>
                                Для составления расписания выберите файл с заполненной таблицей.
                                После выбора файла начнется скачивание результата.
                        </p>
                        <input type='file' id="input" style="display:none">
                        <button style="display:block;" onclick="fake_click()">
                                Выбрать файл
                        </button>
                        <script>
                                function fake_click() {
                                        // сделать неограниченное количество загрузок
                                        // сейчас однократное
                                        document.getElementById("input").click();
                                }
                                // translit[x]=y, где x - код буквы на англ.раскладке,
                                // y - код буквы на рус.раскладке win1251
                                // + пробел и др. неязыковые символы
                                let translit = [  0,  0,  0,  0,  0,  0,  0,  0,
                                                  0,  0, 10,  0,  0,  0,  0,  0,
                                                  0,  0,  0,  0,  0,  0,  0,  0,
                                                  0,  0,  0,  0,  0,  0,  0,  0,
                                                 32,  0,221,  0,  0,  0,  0,253,
                                                  0,  0,  0,  0,225,  0,254,  0,
                                                  0,  0,  0,  0,  0,  0,  0,  0,
                                                  0,  0,198,230,193,  0,222,  0,
                                                  0,212,200,209,194,211,192,207,
                                                208,216,206,203,196,220,210,217,
                                                199,201,202,219,197,195,204,214,
                                                215,205,223,245,  0,250,  0,  0,
                                                184,244,232,241,226,243,224,239,
                                                240,248,238,235,228,252,242,249,
                                                231,233,234,251,229,227,236,246,
                                                247,237,255,213,  0,218,168,  0];
                                function appendStrToIntArray(s,a) {
                                        for(let i = 0; i < s.length; ++i)
                                                a.push(s[i].charCodeAt(0));
                                }
                                function appendTranslitStrToIntArray(s,a) {
                                        for(let i = 0; i < s.length; ++i)
                                                a.push(translit[s[i].charCodeAt(0)]);
                                }
                                function ASCIIarrToInt(arr) {
                                        let res = 0;
                                        for (let i = 0; i < arr.length; ++i) {
                                                res = res * 10 + arr[i] - 48;
                                        }
                                        return res;
                                }
                                document.getElementById("input").addEventListener("change", handleFiles, false);
                                function handleFiles() {
                                        var fr = new FileReader();
                                        fr.onload = function () {
                                                var data = fr.result;
                                                var array = new Uint8Array(data);
                                                process(array);
                                        };
                                        fr.readAsArrayBuffer(document.getElementById("input").files[0]);
                                }
                                function process(s) {
                                        let t = [];
                                        let table = [];
                                        let row = [];
                                        for (let i = 0; i < s.length; ++i) {
                                                if (s[i] == 59) { // ';'
                                                        row.push(t);
                                                        t = [];
                                                } else if (s[i] == 10) { // '\n'
                                                        row.push(t);
                                                        t = [];
                                                        table.push(row);
                                                        row = [];
                                                } else {
                                                        t.push(s[i]);
                                                }
                                        }
                                        let Ncorp = 3, Ndays = 6, Nlessons = 6, Ncab = 100;
                                        // количество классов в каждой параллели
                                        let Nparallel = [[0,0,0,0,0,4,0,0,4,4,4],
                                                         [0,0,0,0,0,0,4,4,0,0,0],
                                                         [0,0,0,0,4,0,0,0,0,0,0]];
                                        let fio = [];
                                        for (let corp = 0; corp < Ncorp; ++corp) {
                                                let week = [];
                                                for (let day = 0; day < Ndays; ++day) {
                                                        let _day = [];
                                                        for (let lesson = 0; lesson < Nlessons; ++lesson) {
                                                                let _lesson = [];
                                                                for(let parallel = 0; parallel < 11; ++parallel) {
                                                                        let _parallel = [];
                                                                        for(let _class = 0; _class < Nparallel[corp][parallel]; ++_class) {
                                                                                _parallel.push([]);
                                                                        }
                                                                        _lesson.push(_parallel);
                                                                }
                                                                _day.push(_lesson);
                                                        }
                                                        week.push(_day);
                                                }
                                                fio.push(week);
                                        }
                                        let cabs = [];
                                        for (let corp = 0; corp < Ncorp; ++corp) {
                                                let week = [];
                                                for (let day = 0; day < Ndays; ++day) {
                                                        let _day = [];
                                                        for (let lesson = 0; lesson < Nlessons; ++lesson) {
                                                                let _lesson = [];
                                                                for(let cab = 0; cab < Ncab; ++cab) {
                                                                        _lesson.push(0);
                                                                }
                                                                _day.push(_lesson);
                                                        }
                                                        week.push(_day);
                                                }
                                                cabs.push(week);
                                        }
                                        for (let i = 1; i < table.length; ++i) {
                                                let fio = table[i][0];
                                                let hrs = ASCIIarrToInt(table[i][1]);
                                                let corp = ASCIIarrToInt(table[i][2]);
                                                let cab = Number(table[i][3]);
                                                let parallel = Number(table[i][4]);
                                                console.log(fio);
                                                console.log(hrs);
                                                console.log(corp);
                                                console.log(cab);
                                                console.log(parallel);
                                                console.log("\n\n");
                                                for (let day = 0; day < Ndays && hrs > 0; ++day) {
                                                        for (let lesson = 0; lesson < Nlessons && hrs > 0; ++lesson) {
                                                                for(let _class = 0; _class < Nparallel[parallel] && hrs > 0; ++_class) {
                                                                        if (fio[corp][day][lesson][parallel][_class].length == 0 &&
                                                                            cabs[corp][day][lesson][cab] == 0) {
                                                                                --hrs;
                                                                                fio[corp][day][lesson][parallel][_class] = fio;
                                                                                cabs[corp][day][lesson][cab] = 1;
                                                                                break; // for(... _class ...), чтобы не ставить
                                                                                // одного учителя в несколько классов за 1 урок
                                                                        }
                                                                }
                                                        }
                                                }
                                        }
                                        s = [];
                                        // дни недели транслитом
                                        let weekday = ["Gjytltkmybr", "Dnjhybr", "Chtlf", "Xtndthu", "Gznybwf", "Ce,,jnf", "Djcrhtctymt"];
                                        for (let corp = 0; corp < Ncorp; ++corp) {
                                                appendTranslitStrToIntArray("Rjhgec ",s);//"Корпус "
                                                appendStrToIntArray((corp + 1).toString() + "\n", s);
                                                for (let day = 0; day < Ndays; ++day) {
                                                        appendTranslitStrToIntArray(weekday[day], s);
                                                        for(let parallel = 0; parallel < 11; ++parallel) {
                                                                for(let i = 0; i < Nparallel[corp][parallel]; ++i) {
                                                                        appendStrToIntArray("; " + (parallel + 1).toString() + "-" + (i + 1).toString(), s);
                                                                }
                                                        }
                                                        appendStrToIntArray("\n", s);
                                                        for (let lesson = 0; lesson < Nlessons; ++lesson) {
                                                                appendStrToIntArray((lesson + 1).toString() + ";", s);
                                                                for(let parallel = 0; parallel < 11; ++parallel) {
                                                                        for(let _class = 0; _class < Nparallel[corp][parallel]; ++_class) {
                                                                                //s.concat(a[corp][day][lesson]);
                                                                                //alert(a[corp][day][lesson]);
                                                                                for(let x = 0; x < fio[corp][day][lesson][parallel][_class].length; ++x)
                                                                                        s.push(fio[corp][day][lesson][parallel][_class][x]);
                                                                                appendStrToIntArray(";", s);
                                                                        }
                                                                }
                                                                appendStrToIntArray("\n", s);
                                                        }
                                                        appendStrToIntArray("\n", s);
                                                }
                                        }
                                        var saveData = (function () {
                                                var a = document.createElement("a");
                                                // document.body.appendChild(a); можно
                                                // a.style = "display: none"; но не нужно
                                                return function (data, fileName) {
                                                        var blob = new Blob([new Uint8Array(data)], { type: "application/octet-stream" });
                                                        var url = window.URL.createObjectURL(blob);
                                                        a.href = url;
                                                        a.download = fileName;
                                                        a.click();
                                                        window.URL.revokeObjectURL(url);
                                                };
                                        })();
                                        saveData(s, "schedule.csv");
                                }
                        </script>
                </div>
        </body>
</html>
